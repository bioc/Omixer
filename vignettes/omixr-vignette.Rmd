---
title: "How to omixR"
shorttitle: "omixR guide"
author: Lucy Sinke, Davy Cats, Leon Mei, and Bas Heijmans*
package: omixR
output:   
  BiocStyle::html_document:
    toc_float: true
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(root.dir = normalizePath(".."))
```

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

Batch effects can have a major impact on the results of omics studies [(Leek et al, 2010)](https://www.nature.com/articles/nrg2825). Randomization is the first, and arguably most influential, step in handling them. However, its implementation suffers from a few key issues:

* A single random draw can inadvertently result in high correlation between technical covariates and biological factors. Particularly in studies with high numbers of batches and outcomes of interest, it is not trivial to minimize these correlations.
* Unless the lab is fully automated, long, randomized sample lists translate poorly into the wet lab. This monotonous presentation of sample layouts is unintuitive and this can result in errors and mixups.
* The randomization process is inherently unclear in many publications, and reproducibility is not always ensured. Randomization methods vary in efficiency between studies, and this is rarely described in papers.

To combat these problems, we developed **omixR** - an R package for multivate randomization and reproducible generation of intuitive sample layouts.

## The Workflow

Using a sample list input, omixR will generate the specified number of randomized sample lists (default: 10,000). It can handle paired samples, keeping these adjacent but shuffling their order.

These lists are then combined with plate layouts, which can be selected from commonly used setups or custom-made. Explicitly masking wells is possible if, for example, you are sharing plates with another study.

After calculating correlations between defined technical covariates and selected randomization factors, a layout is chosen using the following criteria:

* No test provided sufficient evidence to suggest correlation between the variables (all p-values over 0.05)
* From the remaining layouts, return one where the absolute sum of correlations is minimized

The resulting sample layout can then be printed as a list for automated setups, or processed by `omixr_sheet` which returns easy-to-read visual plate layouts for the wet lab.

## Installation

The **omixR** package can be installed using [**devtools**](https://github.com/hadley/devtools) in R.

```{r devtools, eval=FALSE}
library(devtools)
install_github("molepi/omixr")
```    

# A worked example 

In our example, we are investigating how DNA methylation profiles change over time in 4 tissues from 77 individuals.

We have collected 616 samples; one at each of two timepoints for all 4 tissues. Since our primary research question is how the methylome changes over time, we would like to keep the two timepoints adjacent on the array but randomize their order.

Additionally, we want to reserve the final chip (8 wells) on each plate for control samples. This amounts to sending 7 96-well plates for profiling.

## Creating Toy Data

For the example above, we want to create toy data to demonstrate **omixR** functionality. First, we load in the packages that we will need for this worked example.

```{r loadPackages, warning=FALSE, message=FALSE}
library(omixR)
library(tibble)
library(forcats)
library(stringr)
library(dplyr)
library(here)
library(ggplot2)
```

As well as a sample ID, we need to tell **omixR** which variables specify paired sample blocks. Randomization variables in our example are tissue, sex, age, BMI, and isolation date. 

Specifically, it is often important to include isolation date as a randomization variable, as it can introduce technical variations not typically accounted for. 

```{r sampleList}
set.seed(999)

sample_list <- tibble(
  sample_id = str_pad(1:616, 4, pad = "0"), 
  block = rep(1:308, each = 2), 
  time = rep(0:1, 308), 
  tissue = as_factor(rep(c("blood", "fat", "muscle", "saliva"), 
                         each = 2, 77)), 
  sex = as_factor(rep(sample(c("male", "female"), 77, replace = TRUE), 
                      each = 8)), 
  age = round(rep(rnorm(77, mean = 60, sd = 10), each = 8), 0), 
  bmi = round(rep(rnorm(77, mean = 25, sd = 2), each = 8) , 1), 
  isolation_date = rep(sample(seq(as.Date('2015/01/01'), 
                                  as.Date('2020/01/01'), by="day"), 77), 
                       each = 8))

sample_list
```

## Setting up Variables

We set up our randomization variables, and also specify technical covariates. Here, we want to optimize distribution of our biological factors across row (which equates to chip position) and plate. 

```{r randTechVars}
rand_vars <- c("tissue", "sex", "age", "bmi", "isolation_date")
tech_vars <- c("row", "plate")
```

Since the last chip on each plate needs to be reserved, we specify a mask so that **omixR** knows not to assign samples to these wells. 

In the mask, a `0` indicates that a sample will be assigned to that well, and a `1` indicates that it should be left empty.

```{r makeMask}
mask <- c(rep(c(rep(0, 88), rep(1,8)), 7))
```

## Running **omixR**

Now we are ready to perform multivariate randomization with the `omixr_rand` function. Importantly, if the returning correlations are higher than you would like, you can increase the `iter_num` or decrease the number of randomization variables. 

`omixr_rand` will print a visualization of correlations between randomization and technical variables. 

```{r omixrLayout}
omixr_layout <- omixr_rand(sample_list, 
                           sample_id = "sample_id", 
                           block = "block", 
                           iter_num = 100, 
                           plate_layout = "Illumina96", 
                           plate_number = 7, 
                           rand_vars, tech_vars, mask)
```

## **omixR** outperforms Simple Randomization

Looking at the above correlations, you may wonder how **omixR** compares to simple randomization. Briefly, we will investigate this. 

Simple randomization can be replicated using `omixr_rand` with a `iter_num = 1`. Here, only one randomized layout will be created. If this is not optimal, a warning will print but the layout will still be returned. 

```{r simpleRand}
omixr_layout <- omixr_rand(sample_list, 
                           sample_id = "sample_id", 
                           block = "block", 
                           iter_num = 1, 
                           plate_layout = "Illumina96", 
                           plate_number = 7, 
                           rand_vars, tech_vars, mask)
```

Here, we see strong evidence of a correlation between:

* Sex and chip position (r2 = -0.126, p = 0.002)
* Sex and plate (r2 = 0.112, p = 0.006)
* Isolation date and chip position (r2 = 0.086, p = 0.033)

There is also borderline evidence for a correlation between isolation date and plate (r2 = -0.074, p = 0.067). These patterns threaten the validity of our future inferences, as the effects of biological factors are entangled with technical variations. 

In comparison, there is insufficient evidence to suggest correlation between any biological factor and technical covariate in the **omixR** produced layout, and the largest correlation coefficient returned is -0.064, which is considerably lower than many seen in the simple randomized layout.

## Regenerating **omixR** layouts

Since multivariate randomization can take some time with large datasets and many randomization variables, we provide the `omixr_specific` function to reproduce previously generated layouts. After running `omixr_rand`, the seed of the optimal layout is printed, and this can be input into the following function for quick and easy regeneration.

The layout above was generated with a seed of 320.

```{r omixrSpecific, eval=FALSE}
omixr_layout <- omixr_specific(sample_list, 
                               sample_id = "sample_id", 
                               block = "block", 
                               seed = 320, 
                               plate_layout = "Illumina96",
                               plate_number = 7, 
                               rand_vars, tech_vars, mask)
```

# Intuitive Sample Sheets

The bridge between dry and wet labs can be precarious. Technicians are often faced with long, monotonous lists of samples, which they need to pipette accurately to minimize sample mixups. The `omixr_sheet` function smooths this transition by creating PDFs of sample layouts that are intuitive for manual pipetting. 

You can colour code wells by another variable. In our example, we want to highlight wells of each tissue, since samples from one tissue are likely to be stored together. 

An example of the resulting sample sheet for the first plate is shown below.

```{r omixrSheet}
omixr_sheet(omixr_layout, "tissue")
```

<br>

```{r exampleSheet, out.width = '100%', echo=FALSE}
knitr::include_graphics(file.path(here(), "vignettes", "omixr_sample_sheets.png"))
```

# Session Info

```{r}
sessionInfo()
```



